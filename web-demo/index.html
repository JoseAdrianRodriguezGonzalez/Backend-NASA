<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NASA Lunar Tiles 3D Demo</title>
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" />
    <style>
      :root { color-scheme: dark; }
      *, *::before, *::after { box-sizing: border-box; }
      html, body {
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: "Segoe UI", system-ui, sans-serif;
        background: #06090f;
        color: #e2e8f5;
      }
      #app { position: relative; width: 100%; height: 100%; }
      #cesiumContainer { position: absolute; inset: 0; }
      #toolbar {
        position: absolute;
        z-index: 10;
        top: 14px;
        left: 14px;
        display: grid;
        gap: 14px;
        padding: 16px 18px;
        min-width: 270px;
        max-width: min(340px, 30vw);
        border-radius: 16px;
        background: rgba(10, 16, 26, 0.82);
        backdrop-filter: blur(10px);
        box-shadow: 0 22px 50px rgba(0, 0, 0, 0.35);
      }
      #toolbar h1 {
        margin: 0;
        font-size: 15px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #8cb4ff;
      }
      label { display: grid; gap: 6px; font-size: 13px; }
      select, button {
        width: 100%;
        padding: 9px 10px;
        border-radius: 9px;
        border: 1px solid rgba(100, 116, 155, 0.45);
        background: rgba(9, 18, 32, 0.9);
        color: inherit;
        font-size: 13px;
      }
      select:disabled, button:disabled { opacity: 0.55; cursor: not-allowed; }
      button {
        border: none;
        background: linear-gradient(135deg, #3f77ff, #8146ff);
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.03em;
        cursor: pointer;
      }
      #status { font-size: 12px; opacity: 0.8; min-height: 16px; }
      small { font-size: 11px; opacity: 0.65; line-height: 1.45; }
      code { background: rgba(15, 25, 42, 0.9); padding: 2px 4px; border-radius: 4px; }
    </style>
    <script src="datasets.js"></script>
  </head>
  <body>
    <div id="app">
      <div id="cesiumContainer"></div>
      <aside id="toolbar">
        <h1>Lunar Tiles</h1>
        <label>
          Dataset (PYR)
          <select id="datasetSelect" disabled>
            <option>Loading…</option>
          </select>
        </label>
        <label>
          Máscara (opcional)
          <select id="maskSelect" disabled>
            <option>Sin datos</option>
          </select>
        </label>
        <label style="display:flex; align-items:center; gap:8px; font-size:13px;">
          <input type="checkbox" id="lightingToggle" checked /> Iluminación dinámica
        </label>
        <button id="flyHome" disabled>Enfocar dataset</button>
        <div id="status">Preparando datos…</div>
        <small>
          Sirve <code>C:\Users\zzz\Documents</code> con
          <code>python -m http.server 8080 --bind 127.0.0.1</code> y abre
          <code>http://127.0.0.1:8080/GitHub/Backend-NASA/web-demo/</code> para acceder a
          <code>/imagenes</code>.
        </small>
      </aside>
    </div>
    <script type="module">
      import {
        Viewer,
        UrlTemplateImageryProvider,
        GeographicTilingScheme,
        Rectangle,
        EllipsoidTerrainProvider,
        buildModuleUrl,
        Ion,
      } from "https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js";

      Ion.defaultAccessToken = "";
      buildModuleUrl.setBaseUrl("https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/");

      const datasetSelect = document.getElementById("datasetSelect");
      const maskSelect = document.getElementById("maskSelect");
      const lightingToggle = document.getElementById("lightingToggle");
      const flyHomeButton = document.getElementById("flyHome");
      const status = document.getElementById("status");

      const DEFAULT_RECTANGLE = Rectangle.fromDegrees(-180, -90, 180, 90);

      const viewer = new Viewer("cesiumContainer", {
        imageryProvider: undefined,
        baseLayerPicker: false,
        animation: false,
        timeline: false,
        geocoder: false,
        navigationHelpButton: false,
        homeButton: false,
        selectionIndicator: false,
        terrainProvider: new EllipsoidTerrainProvider(),
        scene3DOnly: true,
      });

      viewer.scene.globe.enableLighting = lightingToggle.checked;
      lightingToggle.addEventListener("change", () => {
        viewer.scene.globe.enableLighting = lightingToggle.checked;
      });

      let activeLayer = null;
      let activeMaskLayer = null;
      const datasetsById = new Map();

      function resolveDatasetUrl(url) {
        if (!url) return url;
        if (url.startsWith("/")) {
          return `${window.location.origin}${url}`;
        }
        return new URL(url, window.location.href).href;
      }

      function bootstrapFromManifest() {
        const manifest = window.DATASET_MANIFEST;
        if (!manifest || !Array.isArray(manifest.datasets) || manifest.datasets.length === 0) {
          status.textContent = "No se encontraron datasets en datasets.js";
          return;
        }
        const normalizedDatasets = manifest.datasets.map((entry) => ({
          ...entry,
          url: resolveDatasetUrl(entry.url),
          mask: entry.mask
            ? {
                ...entry.mask,
                url: resolveDatasetUrl(entry.mask.url),
              }
            : undefined,
        }));
        populateDatasetSelect(normalizedDatasets);
        status.textContent = "Selecciona un dataset";
        flyHomeButton.disabled = false;
      }

      function populateDatasetSelect(datasets) {
        datasetSelect.innerHTML = "";
        datasetsById.clear();
        for (const dataset of datasets) {
          datasetsById.set(dataset.id, dataset);
          const option = document.createElement("option");
          option.value = dataset.id;
          option.textContent = dataset.label;
          datasetSelect.appendChild(option);
        }
        datasetSelect.disabled = false;
        datasetSelect.addEventListener("change", onDatasetChange);
        const initial = datasets[0];
        datasetSelect.value = initial.id;
        loadDataset(initial);
      }

      function onDatasetChange(event) {
        const dataset = datasetsById.get(event.target.value);
        if (dataset) {
          loadDataset(dataset);
        }
      }

      function loadDataset(dataset) {
        status.textContent = `Cargando ${dataset.label}…`;
        if (activeLayer) {
          viewer.imageryLayers.remove(activeLayer, true);
          activeLayer = null;
        }
        if (activeMaskLayer) {
          viewer.imageryLayers.remove(activeMaskLayer, true);
          activeMaskLayer = null;
        }

        const provider = new UrlTemplateImageryProvider({
          url: dataset.url,
          tilingScheme: new GeographicTilingScheme({ numberOfLevelZeroTilesX: 2, numberOfLevelZeroTilesY: 1 }),
          minimumLevel: dataset.minLevel ?? 0,
          maximumLevel: dataset.maxLevel ?? 12,
          rectangle: DEFAULT_RECTANGLE,
        });

        activeLayer = viewer.imageryLayers.addImageryProvider(provider);
        status.textContent = `${dataset.label} cargado`;
        configureMask(dataset);
        flyToDataset();
      }

      function configureMask(dataset) {
        maskSelect.innerHTML = "";
        const noneOption = document.createElement("option");
        noneOption.value = "none";
        noneOption.textContent = "Sin máscara";
        maskSelect.appendChild(noneOption);
        maskSelect.disabled = true;

        if (dataset.mask) {
          const option = document.createElement("option");
          option.value = dataset.mask.url;
          option.textContent = dataset.mask.label;
          maskSelect.appendChild(option);
          maskSelect.disabled = false;
        }
        maskSelect.value = "none";
        maskSelect.onchange = () => {
          applyMask(maskSelect.value);
        };
      }

      function applyMask(maskUrl) {
        if (activeMaskLayer) {
          viewer.imageryLayers.remove(activeMaskLayer, true);
          activeMaskLayer = null;
        }
        if (maskUrl === "none") {
          return;
        }
        const provider = new UrlTemplateImageryProvider({
          url: maskUrl,
          tilingScheme: new GeographicTilingScheme({ numberOfLevelZeroTilesX: 2, numberOfLevelZeroTilesY: 1 }),
          minimumLevel: 0,
          maximumLevel: 12,
          rectangle: DEFAULT_RECTANGLE,
        });
        activeMaskLayer = viewer.imageryLayers.addImageryProvider(provider);
        activeMaskLayer.alpha = 0.75;
      }

      function flyToDataset() {
        viewer.camera.flyTo({ destination: DEFAULT_RECTANGLE, duration: 2.5 });
      }

      flyHomeButton.addEventListener("click", () => flyToDataset());

      bootstrapFromManifest();
    </script>
  </body>
</html>
